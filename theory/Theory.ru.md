# __Генерация ландшафтов__

## Содержание

- [Введение](#введение)
- [Теория](#теория)
  - [Карта высот](#карта-высот)
    - [Рендер карты высот](#рендер-карты-высот)
  - [Алгоритмы](#алгоритмы)
    - [Шум Перлина](#шум-перлина)
    - [Diamond Square](#diamond-square)
  - [Применение](#применение)
- [Практика](#практика)
  - [Описание программы](#описание-программы)
    - [Требования](#требования)
    - [Реализовано](#реализовано)
    - [Предстоит](#предстоит)
  - [Используемые инструменты](#используемые-инструменты)

# Введение

Поверхность нашей планеты (Земли) рельефна: полна возвышенностей и впадин. Часто люди хотят повторить те результаты,
на которые у природы заняли миллионы и более лет. Иногда решением выступает человеческое чувство, которое вырабатывалось на протяжении всей его жизни,
и посему он способен более или менее достоверно повторить земные ландшафты; однако это чрезвычайно неэффективно.

Именно поэтому было решено создать программное обеспечение, которое сможет генерировать фотореалистичные ландшафты различного рода.


# Теория

## Карта высот

В компьютерной графике, карта высота или heightmap — это растровое изображение, где каждый пиксель отвечает за
высоту: чёрным цветом представляется самая низкая высота, а белым — самая высокая.

### Рендер карты высот

Существует множество способов, как можно изобразить (отрендерить) карту высот:

- Чёрно-белое изображение, где тёмные пиксели обозначают более низкую высоту, а светлые — более высокую. По сути, это сырые данные о карте высот.\
  ![](https://upload.wikimedia.org/wikipedia/commons/5/57/Heightmap.png)

- Разукрашенное палитрой изображение. Является просто разукрашенной чёрно-белой вариацией карты высот, согласно некоторой палитре.\
  ![](https://i.stack.imgur.com/abflK.gif)

- Трёхмерное отображение.\
  ![](https://www.3d-map-generator.com/wp-content/uploads/2018/12/atlas-feature-tools-heightmap-tools_grayscale-heightmap-example.png)

## Алгоритмы

### Шум Перлина

TBD

### Diamond Square

#### Описание

Алгоритм начинает с создания двумерной пиксельно карты размером $2^n + 1$. Для четырёх угловых точек массива задаются
начальные значения, затем применяются Diamond и Square шаги, пока массив не будет заполнен.

- **Square шаг** [^1]\: Для каждого *квадрата* в массиве его центральная точка устанавливается в среднее арифметическое его вершин + случайная величина.

- **Diamond шаг** [^1]\: Для каждого *ромба* в массиве его центральная точка устанавливается в среднее арифметическое его вершин + случайная величина.

> На каждой итерации значение случайной величины должно быть меньше, чем на предыдущем.

<img src="https://upload.wikimedia.org/wikipedia/commons/thumb/b/bf/Diamond_Square.svg/800px-Diamond_Square.svg.png" data-align="center" alt="">

Во время **Diamond** шага *ромбы* на краях массива могут иметь только 3 вершины вместо 4. Есть несколько вариантов решения
этой проблемы. Самый простой -- использовать среднее арифметическое 3-х вершин. Или же можно взять соответствующее значение с
другой стороны массива. Если задать самые первые угловые точки одинаковыми, то последний способ даст возможность соединять
карту высот саму с собой без разрыва.

В ходе данной работы рассматривались оба варианта, однако в итоге основным был выбран третий.

#### Почанковая генерация

Для почанковой генерации вместо 4-ех начальных точек берется бесконечное множество таких точек (в позициях кратных $2^n$),
что каждый чанк размером $2^n + 1$ имеет 4 угловые начальные точки, которые он делит с соседними чанками.

![](https://psv4.userapi.com/c520036/u380385938/docs/d48/1f6d7665bc5f/Ispolzovanie_opornykh_tochek_v_chankakh.png?extra=EYNNWXf2qXP755k8zp6HURYlLcw4W1fM4UFdk28W0WkHUvvEwCEkrqd7PleVUFjx8EbJP_6XpxpDhG6eYupWiwFP92yUkIH3JOeueHHr24qO0tkg-Iqu0jsOqz2Pi5C2RSItoRSgG42NbrntSUVjx6w)

На **Diamond** шаге на границах берется подходящая точка из соседнего чанка. Эта операция так же требует,
чтобы в соседнем чанке была сгенерирована нужная точка. Однако для этого прилегающему чанку не нужно
генерировать все точки, а только часть наиболее близкую к центральному.

Таким образом для генерации любого произвольного чанка необходимо как минимум создать 16 начальных точек,
используемых в 9 чанках и в правильной последовательности *стянуть* их к центральному **Diamond** и **Square**
шагами, сгенерировав целый чанк и часть точек вокруг.

<Тут могла быть картинка, демонстрирующая это>

#### Достоинства

- Сложность алгоритма $O(N)$, т.е. время работы линейно зависит от размера карты высот.
  $N$ -- Чисто точек карты высот

#### Недостатки (и не совсем)

- Некоторые характерные "артефакты", которые ухудшают получаемый результат, например:

  - Возвышенности и впадины могут иметь характерную форму *звезды*

  - Возвышенности и впадины чаще всего встречаются в точках кратных
    $2^n$, $2^n/2$, $2^n/4$ и т.д.

  > Данные недостатки, как правило, можно неплохо нивелировать

- В отличие от шума Перлина, без генерации некоторой области нельзя получить высоту отдельной точки.

- Полученные в результате генерации значения не нормализованы.


[^1]: В разных источниках названия этих шагов меняются местами.


## Применение

TBD


# Практика

## Описание программы

### Требования

- Кроссплатформенность. Приложение должно работать на любых операционных системах.
- Настраиваемость
    - Выбор из нескольких определённых алгоритмов в качестве основы.
    - Возможность задания различных параметров генерации.
        - Различные константные значения, отвечающие за незначительные в принципе генерации различия.
        - Выбор разных режимов генерации, если алгоритм это поддерживает.
- Поддержка бесконечно генерируемых карт.
- Рендеринг
    - Двумерный рендер карты на плоскости. Различные палитры.
    - Трёхмерное отображение карты высот.
- Удалённые вычисления. Ввиду того, что вычисления, производимые во время генерации, достаточно сложные, необходимо
  добавить возможность производить эти вычисления не прямо на клиенте, а на удалённом сервере.
- Композиция различных алгоритмов, для получения более реалистичных результатов.

### Реализовано

- Кроссплатформенность. Приложение реализовано на веб технологиях, и его можно использовать из любого браузера.
- Клиентская часть приложения написана на языке программирования F#, с использованием компилятора Fable для перевода исходного 
  кода в JavaScript. Для трёхмерного (и двухмерного) рендеринга используется библиотека Three.js.
- Серверная часть приложения написана на языке программирования F#, на платформе .NET, на сервере ASP.NET Core.
- Алгоритмы
    - Реализован алгоритм Diamond Square, с возможностью бесконечной бесшовной почанковой генерации. Также реализованно
      отображение с показом интерполированных (усреднённых) результатов.
- Рендеринг с использованием различных палитр.

### Предстоит

- Указание параметров генерации.
    - Указание как числовых параметров.
    - Указание произвольных функций, необходимых алгоритму, если тот их поддерживает, с последующим исполнением этих функций на стороне сервера.
- Различные варианты рендеринга.
    - Трёхмерное отображение вершин.
    - Фотореалистичные шейдеры.
    
## Используемые инструменты

- .NET — платформа, TBD
- F# — язык программирования, TBD
