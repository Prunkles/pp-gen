# Аннотация

{{TBD}}

# Содержание

- [Содержание](#содержание)
- [Введение](#введение)
- [Теория](#теория)
  - [Карта высот](#карта-высот)
    - [Рендер карты высот](#рендер-карты-высот)
  - [Алгоритмы](#алгоритмы)
    - [Шум Перлина](#шум-перлина)
      - [Использование](#использование)
      - [Сложность](#сложность)
      - [Примеры](#примеры)
    - [Diamond Square](#diamond-square)
      - [Почанковая генерация](#почанковая-генерация)
      - [Достоинства](#достоинства)
      - [Недостатки (и не совсем)](#недостатки-и-не-совсем)
      - [Примеры генерации](#примеры-генерации)
  - [Применение](#применение)
- [Практика](#практика)
  - [Описание разрабатываемой программы](#описание-разрабатываемой-программы)
    - [Требования](#требования)
    - [Реализовано](#реализовано)
    - [Предстоит](#предстоит)
  - [Используемые инструменты](#используемые-инструменты)
  - [{{какая вышла в итоге программа}}](#какая-вышла-в-итоге-программа)
- [Список литературы (референсы)](#список-литературы-референсы)

# Введение

Поверхность нашей планеты (Земли) рельефна: полна возвышенностей и впадин. Часто люди хотят повторить те результаты,
на которые у природы заняли миллионы и более лет. Иногда решением выступает человеческое чувство, которое вырабатывалось на протяжении всей его жизни,
и посему он способен более или менее достоверно повторить земные ландшафты; однако это чрезвычайно неэффективно.

Именно поэтому было решено создать программное обеспечение, которое сможет генерировать фотореалистичные ландшафты различного рода.

Данная работа нацелена на изучение алгоритмов генерации карт высот.

# Теория

## Карта высот

В компьютерной графике, карта высота или heightmap — это растровое изображение, где каждый пиксель отвечает за
высоту: чёрным цветом представляется самая низкая высота, а белым — самая высокая.

### Рендер карты высот

Существует множество способов, как можно изобразить (отрендерить) карту высот:

- Чёрно-белое изображение, где тёмные пиксели обозначают более низкую высоту, а светлые — более высокую. По сути, это сырые данные о карте высот.\
  ![Пример монохромной карты высот](https://upload.wikimedia.org/wikipedia/commons/5/57/Heightmap.png)

- Разукрашенное палитрой изображение. Является просто разукрашенной чёрно-белой вариацией карты высот, согласно некоторой палитре.\
  ![Пример цветной карты высот](https://i.stack.imgur.com/abflK.gif)

- Трёхмерное отображение.\
  ![Пример трёхмерного представления карты высот](https://www.3d-map-generator.com/wp-content/uploads/2018/12/atlas-feature-tools-heightmap-tools_grayscale-heightmap-example.png)

## Алгоритмы

### Шум Перлина

Вид градиентного шума, разработанный Кенон Перлином в 1983 году.

#### Использование

Шум перлина это примитив процедурных текстур, тип градиентного шума, используемый в визуальных эффектах художниками, чтобы улучшить реалистичность внешнего вида в компьютерной графике. Эта функция имеет псевдо-рандомный вид, и все её визуальные части одного размера. Это свойство позволяет легко управлять им; несколько отмасштабированных копий шума Перлина могут быть вставлены в математическое выражение, чтобы создать процедурную текстуру с хорошей вариативностью. Искуственные текстуры часто используют в CGI, чтобы сделать внешний вид сгенерированных компьютером визуальные элементов — такие как поверхности объектов, огонь, дым, или облака — более натуральным, имитируя контролируемое случайное появление текстур в природе.

#### Сложность

Для каждого вычисления функции шума, скалярное произведение позиции и градиента векторов должны быть вычислены в каждом узле содержащей клетки сетки. Таким образом, шум Перлина масштабируется с сложностью $O(n^2)$ для $n$ измерений.

#### Примеры

![Монохромный шум Перлина](https://hsto.org/getpro/habr/post_images/0ca/7bd/595/0ca7bd5956a3aa93d6ec570a5aabe49d.gif)
![Разукрашенный шум Перлина](https://cs9.pikabu.ru/post_img/big/2017/08/20/10/1503250600176869676.png)


### Diamond Square

Идея этого алгоритма была впервые представлена Фурнье, Фасселлом и Карпентером на SIGGRAPH 1982.
Алгоритм diamond-square был проанализирован Гевином С. П. Миллером на SIGGRAPH 1986, и описал его как вовсе не идеальным, потому что алгоритм производит заметные вертикальные и горизонтальные "складки" из-за наиболее значительного возмущения, происходящего в прямоугольной сетке.

Алгоритм начинает с создания двумерной пиксельно карты размером $2^n + 1$. Для четырёх угловых точек массива задаются
начальные значения, затем применяются Diamond и Square шаги, пока массив не будет заполнен.

- **Square шаг** [^1]\: Для каждого *квадрата* в массиве его центральная точка устанавливается в среднее арифметическое его вершин + случайная величина.

- **Diamond шаг** [^1]\: Для каждого *ромба* в массиве его центральная точка устанавливается в среднее арифметическое его вершин + случайная величина.

> На каждой итерации значение случайной величины должно быть меньше, чем на предыдущем.

![Иллюстрация шагов Diamond-Square](https://upload.wikimedia.org/wikipedia/commons/thumb/b/bf/Diamond_Square.svg/800px-Diamond_Square.svg.png)

Во время **Diamond** шага *ромбы* на краях массива могут иметь только 3 вершины вместо 4. Есть несколько вариантов решения
этой проблемы. Самый простой -- использовать среднее арифметическое 3-х вершин. Или же можно взять соответствующее значение с
другой стороны массива. Если задать самые первые угловые точки одинаковыми, то последний способ даст возможность соединять
карту высот саму с собой без разрыва.

В ходе данной работы рассматривались оба варианта, однако в итоге основным был выбран третий.

#### Почанковая генерация

Для почанковой генерации вместо 4-ех начальных точек берется бесконечное множество таких точек (в позициях кратных $2^n$),
что каждый чанк размером $2^n + 1$ имеет 4 угловые начальные точки, которые он делит с соседними чанками.

На **Diamond** шаге на границах берется подходящая точка из соседнего чанка. Эта операция так же требует,
чтобы в соседнем чанке была сгенерирована нужная точка. Однако для этого прилегающему чанку не нужно
генерировать все точки, а только часть наиболее близкую к центральному.

Таким образом для генерации любого произвольного чанка необходимо как минимум создать 16 начальных точек,
используемых в 9 чанках и в правильной последовательности *стянуть* их к центральному **Diamond** и **Square**
шагами, сгенерировав целый чанк и часть точек вокруг.

![Иллюстрация генерации двух смежных чанков с дополнительной генерацией необходимых точек](https://sun9-48.userapi.com/impg/BrOq9_MybYtY6W033Z2hD8DMom8Z1rcTxLYNrg/x6-gCAl7BM0.jpg?size=783x614&quality=96&sign=f6103b74739b5a543cd744cda9f5b5ee&type=album)

#### Достоинства

- Сложность алгоритма $O(N)$, т.е. время работы линейно зависит от размера карты высот.
  $N$ — Чисто точек карты высот

#### Недостатки (и не совсем)

- Некоторые характерные "артефакты", которые ухудшают получаемый результат, например:

  - Возвышенности и впадины могут иметь характерную форму *звезды*

  - Возвышенности и впадины чаще всего встречаются в точках кратных
    $2^n$, $2^n/2$, $2^n/4$ и т.д.

  > Данные недостатки, как правило, можно неплохо нивелировать

- В отличие от шума Перлина, без генерации некоторой области нельзя получить высоту отдельной точки.

- Полученные в результате генерации значения не нормализованы.


[^1]: В разных источниках названия этих шагов меняются местами.

#### Примеры генерации
![Результат классического diamond-square](http://www.bluh.org/wp-content/uploads/2012/01/done.png)

![Большая область из нескольких чанков](https://sun9-25.userapi.com/impg/rxrXS7nT2I-hQnsofMlj-T8kN3W8uCTYtSwMBQ/bJRs9ZNsVEo.jpg?size=689x687&quality=96&sign=c9fd578ecd1b0c42e5de1369d04f94ae&type=album)

![Область из нескольких чанков, с палитрой](https://sun9-49.userapi.com/impg/P0jMEDyFdwspEHgncn3rpVw-u78M6Bt6Q8_Bgw/yBynTdy3jwM.jpg?size=1024x1024&quality=96&sign=6741164ee834b97a61ae5397bba18b74&type=album)


## Применение

TBD


# Практика

Ввиду того, что найденные существующие не удовлетворяли нижеупомянутым требованиям,
было решено разработать собственное программное обеспечение, которое, в
добавок ко всему, также способствует развитию знаний, навыков и умений автора
работы.

## Описание разрабатываемой программы

### Требования

- Кроссплатформенность. Приложение должно работать на любых операционных системах.
- Настраиваемость
    - Выбор из нескольких определённых алгоритмов в качестве основы.
    - Возможность задания различных параметров генерации.
        - Различные константные значения, отвечающие за незначительные в принципе генерации различия.
        - Выбор разных режимов генерации, если алгоритм это поддерживает.
- Поддержка бесконечно генерируемых карт.
- Рендеринг
    - Двумерный рендер карты на плоскости. Различные палитры.
    - Трёхмерное отображение карты высот.
- Удалённые вычисления. Ввиду того, что вычисления, производимые во время генерации, достаточно сложные, необходимо
  добавить возможность производить эти вычисления не прямо на клиенте, а на удалённом сервере.
- Композиция различных алгоритмов, для получения более реалистичных результатов.

### Реализовано

- Кроссплатформенность. Приложение реализовано на веб технологиях, и его можно использовать из любого браузера.
- Клиентская часть приложения написана на языке программирования F#, с использованием компилятора Fable для перевода исходного 
  кода в JavaScript. Для трёхмерного (и двухмерного) рендеринга используется библиотека Three.js.
- Серверная часть приложения написана на языке программирования F#, на платформе .NET, на сервере ASP.NET Core.
- Алгоритмы
    - Реализован алгоритм Diamond Square, с возможностью бесконечной бесшовной почанковой генерации. Также реализованно
      отображение с показом интерполированных (усреднённых) результатов.
- Рендеринг с использованием различных палитр.

### Предстоит

- Указание параметров генерации.
    - Указание как числовых параметров.
    - Указание произвольных функций, необходимых алгоритму, если тот их поддерживает, с последующим исполнением этих функций на стороне сервера.
- Различные варианты рендеринга.
    - Трёхмерное отображение вершин.
    - Фотореалистичные шейдеры.

## Используемые инструменты

- .NET — платформа разработки.
- ASP.NET Core — фреймворк для написания серверов на платформе .NET. Использовался
  для написания серверной части.
- F# — язык программирования. Использовался для fullstack разработки.
- Fable — компилятор языка программирования F# в язык программирования JavaScript,
  который после можно использовать для веб разработки.
- Three.js — библиотека на JavaScript для трёхмерной комьпютерной графики.
- React — фреймворк для JavaScript для реактивного GUI (Graphical User Interface).

## {{какая вышла в итоге программа}}

Исходный код расположен на удалённом сервере GitLab, использующий систему контроля
версий Git: [https://gitlab.com/p-dev/ppgen](https://gitlab.com/p-dev/ppgen)

Программу можно опробовать по ссылке {{указать ссылку}}.

{{вставить дословные скриншоты программы}}

# Список литературы (референсы)

- В большей мере работа была вдохновлена другой работой на схожую тему.
    - Презентация: http://hjemmesider.diku.dk/~torbenm/Planet/PSIslides.pdf
    - Веб-интерфейс: https://topps.diku.dk/torbenm/maps.msp
